<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <!-- Preferences (Interface -> Implementation mappings) -->
    <preference for="Infinri\Core\Api\ConfigInterface" type="Infinri\Core\Model\Config\ScopeConfig"/>
    <preference for="Infinri\Core\Api\ComponentRegistrarInterface" type="Infinri\Core\Model\ComponentRegistrar"/>
    <preference for="Infinri\Core\Api\CacheInterface" type="Infinri\Core\Model\Cache\Pool"/>
    
    <!-- Virtual Types for Cache Pools -->
    <virtualType name="Infinri\Core\Model\Cache\ConfigCachePool" type="Infinri\Core\Model\Cache\Pool">
        <arguments>
            <argument name="cache" xsi:type="object">Infinri\Core\Model\Cache\ConfigCacheAdapter</argument>
            <argument name="defaultTtl" xsi:type="number">3600</argument>
        </arguments>
    </virtualType>
    
    <virtualType name="Infinri\Core\Model\Cache\LayoutCachePool" type="Infinri\Core\Model\Cache\Pool">
        <arguments>
            <argument name="cache" xsi:type="object">Infinri\Core\Model\Cache\LayoutCacheAdapter</argument>
            <argument name="defaultTtl" xsi:type="number">3600</argument>
        </arguments>
    </virtualType>
    
    <!-- Cache Adapters -->
    <virtualType name="Infinri\Core\Model\Cache\ConfigCacheAdapter" type="Symfony\Component\Cache\Adapter\FilesystemAdapter">
        <arguments>
            <argument name="namespace" xsi:type="string">config</argument>
            <argument name="defaultLifetime" xsi:type="number">0</argument>
            <argument name="directory" xsi:type="string">var/cache/config</argument>
        </arguments>
    </virtualType>
    
    <virtualType name="Infinri\Core\Model\Cache\LayoutCacheAdapter" type="Symfony\Component\Cache\Adapter\FilesystemAdapter">
        <arguments>
            <argument name="namespace" xsi:type="string">layout</argument>
            <argument name="defaultLifetime" xsi:type="number">0</argument>
            <argument name="directory" xsi:type="string">var/cache/layout</argument>
        </arguments>
    </virtualType>
    
    <!-- Inject Cache Pools into Loaders -->
    <type name="Infinri\Core\Model\Config\Loader">
        <arguments>
            <argument name="cachePool" xsi:type="object">Infinri\Core\Model\Cache\ConfigCachePool</argument>
        </arguments>
    </type>
    
    <type name="Infinri\Core\Model\Layout\Loader">
        <arguments>
            <argument name="cachePool" xsi:type="object">Infinri\Core\Model\Cache\LayoutCachePool</argument>
        </arguments>
    </type>

    <!-- Security: CSRF Token Management -->
    <type name="Infinri\Core\Security\CsrfTokenManager">
        <arguments>
            <!-- Dependencies auto-wired by constructor -->
        </arguments>
    </type>
    
    <!-- Security: CSRF Helper for Templates -->
    <type name="Infinri\Core\Helper\Csrf">
        <arguments>
            <argument name="csrfManager" xsi:type="object">Infinri\Core\Security\CsrfTokenManager</argument>
        </arguments>
    </type>
    
    <!-- Security: CSRF Protection Middleware -->
    <type name="Infinri\Core\App\Middleware\CsrfProtectionMiddleware">
        <arguments>
            <argument name="csrfManager" xsi:type="object">Infinri\Core\Security\CsrfTokenManager</argument>
        </arguments>
    </type>
    
    <!-- Security: Authentication Middleware -->
    <type name="Infinri\Core\App\Middleware\AuthenticationMiddleware">
        <!-- No constructor dependencies -->
    </type>
    
    <!-- Admin: User Resource Model -->
    <type name="Infinri\Admin\Model\ResourceModel\AdminUser">
        <arguments>
            <argument name="connection" xsi:type="object">Infinri\Core\Model\ResourceModel\Connection</argument>
        </arguments>
    </type>
    
    <!-- Admin: User Model -->
    <type name="Infinri\Admin\Model\AdminUser">
        <arguments>
            <argument name="resource" xsi:type="object">Infinri\Admin\Model\ResourceModel\AdminUser</argument>
        </arguments>
    </type>
    
    <!-- Auth: Login Controllers -->
    <type name="Infinri\Auth\Controller\Adminhtml\Login\Index">
        <arguments>
            <argument name="request" xsi:type="object">Infinri\Core\App\Request</argument>
            <argument name="response" xsi:type="object">Infinri\Core\App\Response</argument>
            <argument name="layoutFactory" xsi:type="object">Infinri\Core\Model\View\LayoutFactory</argument>
        </arguments>
    </type>
    
    <type name="Infinri\Auth\Controller\Adminhtml\Login\Post">
        <arguments>
            <argument name="request" xsi:type="object">Infinri\Core\App\Request</argument>
            <argument name="response" xsi:type="object">Infinri\Core\App\Response</argument>
            <argument name="adminUserResource" xsi:type="object">Infinri\Admin\Model\ResourceModel\AdminUser</argument>
            <argument name="csrfManager" xsi:type="object">Infinri\Core\Security\CsrfTokenManager</argument>
            <argument name="rememberTokenService" xsi:type="object">Infinri\Admin\Service\RememberTokenService</argument>
        </arguments>
    </type>
    
    <type name="Infinri\Auth\Controller\Adminhtml\Login\Logout">
        <arguments>
            <argument name="request" xsi:type="object">Infinri\Core\App\Request</argument>
            <argument name="response" xsi:type="object">Infinri\Core\App\Response</argument>
            <argument name="rememberTokenService" xsi:type="object">Infinri\Admin\Service\RememberTokenService</argument>
        </arguments>
    </type>
    
    <!-- Auth: Login Form Block -->
    <type name="Infinri\Auth\Block\Adminhtml\Login\Form">
        <arguments>
            <argument name="csrfManager" xsi:type="object">Infinri\Core\Security\CsrfTokenManager</argument>
        </arguments>
    </type>
    
    <!-- Admin: Dashboard Controller -->
    <type name="Infinri\Admin\Controller\Adminhtml\Index\Index">
        <arguments>
            <argument name="request" xsi:type="object">Infinri\Core\App\Request</argument>
            <argument name="response" xsi:type="object">Infinri\Core\App\Response</argument>
            <argument name="layoutFactory" xsi:type="object">Infinri\Core\Model\View\LayoutFactory</argument>
        </arguments>
    </type>
    
    <!-- Front Controller -->
    <type name="Infinri\Core\App\FrontController">
        <arguments>
            <argument name="router" xsi:type="object">Infinri\Core\App\Router</argument>
            <argument name="objectManager" xsi:type="object">Infinri\Core\Model\ObjectManager</argument>
            <argument name="request" xsi:type="object">Infinri\Core\App\Request</argument>
            <argument name="securityHeaders" xsi:type="object">Infinri\Core\App\Middleware\SecurityHeadersMiddleware</argument>
            <argument name="authMiddleware" xsi:type="object">Infinri\Core\App\Middleware\AuthenticationMiddleware</argument>
        </arguments>
    </type>
    
    <!-- Authentication Middleware -->
    <type name="Infinri\Core\App\Middleware\AuthenticationMiddleware">
        <arguments>
            <argument name="rememberTokenService" xsi:type="object">Infinri\Admin\Service\RememberTokenService</argument>
            <argument name="adminUserResource" xsi:type="object">Infinri\Admin\Model\ResourceModel\AdminUser</argument>
        </arguments>
    </type>
    
    <!-- Schema Setup -->
    <type name="Infinri\Core\Model\Setup\SchemaSetup">
        <arguments>
            <argument name="connection" xsi:type="object">Infinri\Core\Model\ResourceModel\Connection</argument>
        </arguments>
    </type>
    
    <!-- Admin: User Management -->
    <type name="Infinri\Admin\Controller\Adminhtml\User\Index">
        <arguments>
            <argument name="uiComponentRenderer" xsi:type="object">Infinri\Core\View\Element\UiComponentRenderer</argument>
            <argument name="adminLayout" xsi:type="object">Infinri\Cms\Helper\AdminLayout</argument>
        </arguments>
    </type>
    
    <type name="Infinri\Admin\Controller\Adminhtml\User\Edit">
        <arguments>
            <argument name="adminUserResource" xsi:type="object">Infinri\Admin\Model\ResourceModel\AdminUser</argument>
            <argument name="adminLayout" xsi:type="object">Infinri\Cms\Helper\AdminLayout</argument>
        </arguments>
    </type>
    
    <type name="Infinri\Admin\Controller\Adminhtml\User\Create">
        <arguments>
            <argument name="adminLayout" xsi:type="object">Infinri\Cms\Helper\AdminLayout</argument>
        </arguments>
    </type>
    
    <type name="Infinri\Admin\Controller\Adminhtml\User\Save">
        <arguments>
            <argument name="adminUserResource" xsi:type="object">Infinri\Admin\Model\ResourceModel\AdminUser</argument>
        </arguments>
    </type>
    
    <type name="Infinri\Admin\Controller\Adminhtml\User\Delete">
        <arguments>
            <argument name="adminUserResource" xsi:type="object">Infinri\Admin\Model\ResourceModel\AdminUser</argument>
        </arguments>
    </type>
    
    <!-- Note: DataProvider parameters (name, primaryFieldName, requestFieldName) are passed by UiComponentRenderer -->
    <!-- We only configure the injected dependencies here -->
    
    <type name="Infinri\Admin\Block\Adminhtml\User\Grid">
        <arguments>
            <argument name="adminUserResource" xsi:type="object">Infinri\Admin\Model\ResourceModel\AdminUser</argument>
        </arguments>
    </type>
</config>


