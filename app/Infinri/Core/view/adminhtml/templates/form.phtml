<?php
/**
 * Admin Form Template
 * @var string $pageTitle
 * @var array $buttons
 * @var array $fieldsets
 * @var array $data
 * @var bool $isNew
 */

$entityType = $entityType ?? 'page';
$formIdAttr = $entityType . '-form';

// Set form action based on entity type
$formAction = match($entityType) {
    'block' => '/admin/cms/block/save',
    'widget' => '/admin/cms/widget/save',
    'user' => '/admin/users/save',
    default => '/admin/cms/page/save',
};

// Set primary field name based on entity type
$primaryFieldName = $primaryField ?? match($entityType) {
    'block' => 'block_id',
    'widget' => 'widget_id',
    'user' => 'user_id',
    default => 'page_id',
};

$primaryIdValue = $data[$primaryFieldName] ?? null;
?>
<!DOCTYPE html>
<html>
<head>
    <title><?= htmlspecialchars($pageTitle) ?></title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; margin: 0; }
        .page-header { background: white; padding: 20px 30px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
        .page-title { font-size: 24px; color: #1e293b; margin: 0; }
        .page-actions { margin-top: 15px; display: flex; gap: 10px; }
        .form-container { max-width: 1200px; margin: 0 auto; }
        .fieldset { background: white; padding: 25px 30px; margin-bottom: 20px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .fieldset-legend { font-size: 18px; font-weight: 600; color: #334155; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #475569; font-size: 14px; }
        label.required:after { content: ' *'; color: #dc2626; }
        input[type="text"], textarea { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; font-family: inherit; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        textarea { min-height: 120px; font-family: 'Courier New', monospace; resize: vertical; }
        .field-notice { display: block; margin-top: 4px; font-size: 12px; color: #64748b; }
        .checkbox-group { display: flex; align-items: center; margin-bottom: 20px; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        .checkbox-group label { margin-bottom: 0; font-weight: 500; }
        .button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.2s; }
        .button.primary { background: #2563eb; color: white; }
        .button.primary:hover { background: #1d4ed8; }
        .button.save { background: #059669; color: white; }
        .button.save:hover { background: #047857; }
        .button.back { background: #6b7280; color: white; }
        .button.back:hover { background: #4b5563; }
        .button.delete { background: #dc2626; color: white; }
        .button.delete:hover { background: #b91c1c; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="page-header">
        <h1 class="page-title"><?= htmlspecialchars($pageTitle) ?></h1>
        <div class="page-actions">
            <?php foreach ($buttons as $button): ?>
                <?php if ($button['name'] === 'save'): ?>
                    <button type="submit" class="button <?= htmlspecialchars($button['class']) ?>" 
                            form="<?= htmlspecialchars($formIdAttr) ?>">
                        <?= htmlspecialchars($button['label']) ?>
                    </button>
                <?php elseif ($button['name'] === 'save_and_continue'): ?>
                    <button type="submit" class="button <?= htmlspecialchars($button['class']) ?>" 
                            form="<?= htmlspecialchars($formIdAttr) ?>" 
                            name="save_and_continue"
                            value="1">
                        <?= htmlspecialchars($button['label']) ?>
                    </button>
                <?php elseif ($button['name'] === 'delete'): ?>
                    <a href="<?= htmlspecialchars($button['url']) ?>" 
                       class="button <?= htmlspecialchars($button['class']) ?>"
                       onclick="return confirm('Are you sure you want to delete this page?')">
                        <?= htmlspecialchars($button['label']) ?>
                    </a>
                <?php else: ?>
                    <a href="<?= htmlspecialchars($button['url']) ?>" 
                       class="button <?= htmlspecialchars($button['class']) ?>">
                        <?= htmlspecialchars($button['label']) ?>
                    </a>
                <?php endif; ?>
            <?php endforeach; ?>
        </div>
    </div>
    
    <div class="form-container">
        <form action="<?= htmlspecialchars($formAction) ?>" method="POST" id="<?= htmlspecialchars($formIdAttr) ?>">
            <?= $csrfField ?? '' ?>
            <?php if ($primaryIdValue !== null): ?>
                <input type="hidden" name="<?= htmlspecialchars($primaryFieldName) ?>" value="<?= htmlspecialchars((string)$primaryIdValue) ?>">
            <?php endif; ?>
            <?php foreach ($fieldsets as $fieldset): ?>
                <div class="fieldset">
                    <div class="fieldset-legend"><?= htmlspecialchars($fieldset['label']) ?></div>
                    
                    <?php foreach ($fieldset['fields'] as $field): ?>
                        <?php if (!$field['visible']): ?>
                            <!-- Hidden field -->
                            <input type="hidden" 
                                   name="<?= htmlspecialchars($field['name']) ?>" 
                                   value="<?= htmlspecialchars($data[$field['dataScope']] ?? '') ?>">
                        <?php elseif ($field['type'] === 'checkbox'): ?>
                            <div class="checkbox-group">
                                <input type="checkbox" 
                                       id="<?= htmlspecialchars($field['name']) ?>" 
                                       name="<?= htmlspecialchars($field['name']) ?>" 
                                       value="1"
                                       <?= !empty($data[$field['dataScope']]) ? 'checked' : '' ?>>
                                <label for="<?= htmlspecialchars($field['name']) ?>">
                                    <?= htmlspecialchars($field['label']) ?>
                                </label>
                            </div>
                        <?php else: ?>
                            <div class="form-group">
                                <label for="<?= htmlspecialchars($field['name']) ?>" 
                                       class="<?= $field['required'] ? 'required' : '' ?>">
                                    <?= htmlspecialchars($field['label']) ?>
                                </label>
                                
                                <?php if ($field['type'] === 'textarea'): ?>
                                    <textarea id="<?= htmlspecialchars($field['name']) ?>" 
                                              name="<?= htmlspecialchars($field['name']) ?>"
                                              rows="<?= $field['rows'] ?>"
                                              <?= $field['required'] ? 'required' : '' ?>><?= htmlspecialchars($data[$field['dataScope']] ?? '') ?></textarea>
                                    <?php if ($field['name'] === 'content'): ?>
                                        <button type="button" onclick="openImagePicker('<?= htmlspecialchars($field['name']) ?>')" 
                                                style="margin-top: 10px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                            üñºÔ∏è Browse Images
                                        </button>
                                    <?php endif; ?>
                                <?php else: ?>
                                    <input type="text" 
                                           id="<?= htmlspecialchars($field['name']) ?>" 
                                           name="<?= htmlspecialchars($field['name']) ?>"
                                           value="<?= htmlspecialchars($data[$field['dataScope']] ?? '') ?>"
                                           <?= $field['required'] ? 'required' : '' ?>>
                                <?php endif; ?>
                                
                                <?php if ($field['notice']): ?>
                                    <small class="field-notice"><?= htmlspecialchars($field['notice']) ?></small>
                                <?php endif; ?>
                            </div>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>
            <?php endforeach; ?>
        </form>
    </div>
    
    <!-- Image Picker Modal -->
    <div id="image-picker-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; width: 90%; max-width: 1200px; height: 90%; border-radius: 8px; display: flex; flex-direction: column;">
            <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">Select Image</h2>
                <button onclick="closeImagePicker()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <iframe id="image-picker-frame" src="" style="flex: 1; border: none;"></iframe>
        </div>
    </div>
    
    <script>
        let currentTargetField = null;
        let cursorPosition = 0;
        
        // Track cursor position in textareas
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('click', function() {
                cursorPosition = this.selectionStart;
            });
            textarea.addEventListener('keyup', function() {
                cursorPosition = this.selectionStart;
            });
        });
        
        function openImagePicker(fieldName) {
            currentTargetField = document.getElementById(fieldName);
            cursorPosition = currentTargetField.selectionStart;
            
            const modal = document.getElementById('image-picker-modal');
            const iframe = document.getElementById('image-picker-frame');
            iframe.src = '/admin/infinri_media/media/picker';
            modal.style.display = 'flex';
        }
        
        function closeImagePicker() {
            document.getElementById('image-picker-modal').style.display = 'none';
            document.getElementById('image-picker-frame').src = '';
        }
        
        // Listen for image selection from iframe
        window.addEventListener('message', function(event) {
            if (event.data.type === 'imageSelected' && currentTargetField) {
                const imageUrl = event.data.url;
                const imageTag = '<img src="' + imageUrl + '" alt="Image" style="max-width: 100%;">';
                
                // Insert at cursor position
                const content = currentTargetField.value;
                const newContent = content.substring(0, cursorPosition) + imageTag + content.substring(cursorPosition);
                currentTargetField.value = newContent;
                
                // Move cursor after inserted image
                cursorPosition += imageTag.length;
                currentTargetField.setSelectionRange(cursorPosition, cursorPosition);
                currentTargetField.focus();
                
                closeImagePicker();
            }
        });
    </script>
</body>
</html>
