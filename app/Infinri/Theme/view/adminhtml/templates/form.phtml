<?php
/**
 * Admin Form Template
 * @var string $pageTitle
 * @var array $buttons
 * @var array $fieldsets
 * @var array $data
 * @var bool $isNew
 */

$entityType = $entityType ?? 'page';
$formIdAttr = $entityType . '-form';

// Set form action based on entity type
$formAction = match ($entityType) {
    'menu' => '/admin/menu/menu/save',
    'menuitem' => '/admin/menu/menuitem/save',
    'block' => '/admin/cms/block/save',
    'widget' => '/admin/cms/widget/save',
    'user' => '/admin/users/save',
    default => '/admin/cms/page/save',
};

// Set primary field name based on entity type
$primaryFieldName = $primaryField ?? match ($entityType) {
    'menu' => 'menu_id',
    'menuitem' => 'item_id',
    'block' => 'block_id',
    'widget' => 'widget_id',
    'user' => 'user_id',
    default => 'page_id',
};

$primaryIdValue = $data[$primaryFieldName] ?? null;
?>
<!-- Styles are defined in Theme/view/adminhtml/web/css/source/_admin-forms.less -->
<div class="page-header">
    <h1 class="page-title"><?= htmlspecialchars($pageTitle) ?></h1>
    <div class="page-actions">
        <?php foreach ($buttons as $button): ?>
            <?php if ($button['name'] === 'save'): ?>
                <button type="submit" class="button <?= htmlspecialchars($button['class']) ?>"
                        form="<?= htmlspecialchars($formIdAttr) ?>">
                    <?= htmlspecialchars($button['label']) ?>
                </button>
            <?php elseif ($button['name'] === 'save_and_continue'): ?>
                <button type="submit" class="button <?= htmlspecialchars($button['class']) ?>"
                        form="<?= htmlspecialchars($formIdAttr) ?>"
                        name="save_and_continue"
                        value="1">
                    <?= htmlspecialchars($button['label']) ?>
                </button>
            <?php elseif ($button['name'] === 'delete'): ?>
                <a href="<?= htmlspecialchars($button['url']) ?>"
                   class="button button-delete <?= htmlspecialchars($button['class']) ?>"
                   data-confirm="Are you sure you want to delete this page?">
                    <?= htmlspecialchars($button['label']) ?>
                </a>
            <?php else: ?>
                <a href="<?= htmlspecialchars($button['url']) ?>"
                   class="button <?= htmlspecialchars($button['class']) ?>">
                    <?= htmlspecialchars($button['label']) ?>
                </a>
            <?php endif; ?>
        <?php endforeach; ?>
    </div>
</div>

<div class="form-container">
    <form action="<?= htmlspecialchars($formAction) ?>" method="POST" id="<?= htmlspecialchars($formIdAttr) ?>">
        <?= $csrfField ?? '' ?>
        <?php if ($primaryIdValue !== null): ?>
            <input type="hidden" name="<?= htmlspecialchars($primaryFieldName) ?>"
                   value="<?= htmlspecialchars((string)$primaryIdValue) ?>">
        <?php endif; ?>
        <?php foreach ($fieldsets as $fieldset): ?>
            <div class="fieldset">
                <div class="fieldset-legend"><?= htmlspecialchars($fieldset['label']) ?></div>

                <?php foreach ($fieldset['fields'] as $field): ?>
                    <?php if (!$field['visible']): ?>
                        <!-- Hidden field -->
                        <input type="hidden"
                               name="<?= htmlspecialchars($field['name']) ?>"
                               value="<?= htmlspecialchars($data[$field['dataScope']] ?? '') ?>">
                    <?php elseif (!empty($field['template'])): ?>
                        <!-- Custom template field -->
                        <?php
                        // Resolve template path (e.g., "Infinri_Menu::form/field/checkboxset-with-sortorder")
                        $templateParts = explode('::', $field['template']);
                        if (count($templateParts) === 2) {
                            [$moduleName, $templatePath] = $templateParts;
                            // Convert Infinri_Menu to Infinri/Menu
                            $moduleDir = str_replace('_', '/', $moduleName);
                            // __DIR__ is app/Infinri/Theme/view/adminhtml/templates
                            // Go up 5 levels to get to app/, then append module path
                            $customTemplatePath = __DIR__ . '/../../../../../' . $moduleDir . '/view/adminhtml/templates/' . $templatePath . '.phtml';
                            
                            if (file_exists($customTemplatePath)) {
                                // Create a simple block-like object to pass data
                                $block = new class($data[$field['dataScope']] ?? [], $field['name']) {
                                    private $data = [];
                                    public function __construct($fieldData, $fieldName) {
                                        $this->data = ['cms_pages' => $fieldData, 'name' => $fieldName];
                                    }
                                    public function getData($key = null) {
                                        return $key ? ($this->data[$key] ?? null) : $this->data;
                                    }
                                    public function escapeHtml($value) {
                                        return htmlspecialchars($value ?? '', ENT_QUOTES, 'UTF-8');
                                    }
                                    public function escapeHtmlAttr($value) {
                                        return htmlspecialchars($value ?? '', ENT_QUOTES, 'UTF-8');
                                    }
                                };
                                include $customTemplatePath;
                            } else {
                                echo '<p style="color:red;">Template not found: ' . htmlspecialchars($customTemplatePath) . '</p>';
                            }
                        }
                        ?>
                    <?php elseif ($field['type'] === 'checkbox'): ?>
                        <div class="checkbox-group">
                            <input type="checkbox"
                                   id="<?= htmlspecialchars($field['name']) ?>"
                                   name="<?= htmlspecialchars($field['name']) ?>"
                                   value="1"
                                    <?= !empty($data[$field['dataScope']]) ? 'checked' : '' ?>>
                            <label for="<?= htmlspecialchars($field['name']) ?>">
                                <?= htmlspecialchars($field['label']) ?>
                            </label>
                        </div>
                    <?php else: ?>
                        <div class="form-group">
                            <label for="<?= htmlspecialchars($field['name']) ?>"
                                   class="<?= $field['required'] ? 'required' : '' ?>">
                                <?= htmlspecialchars($field['label']) ?>
                            </label>

                            <?php if ($field['type'] === 'textarea'): ?>
                                <textarea id="<?= htmlspecialchars($field['name']) ?>"
                                          name="<?= htmlspecialchars($field['name']) ?>"
                                          rows="<?= $field['rows'] ?>"
                                              <?= $field['required'] ? 'required' : '' ?>><?= htmlspecialchars($data[$field['dataScope']] ?? '') ?></textarea>
                                <?php if ($field['name'] === 'content'): ?>
                                    <button type="button"
                                            class="btn-image-picker"
                                            data-field="<?= htmlspecialchars($field['name']) ?>"
                                            style="margin-top: 10px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                        üñºÔ∏è Browse Images
                                    </button>
                                <?php endif; ?>
                            <?php else: ?>
                                <input type="text"
                                       id="<?= htmlspecialchars($field['name']) ?>"
                                       name="<?= htmlspecialchars($field['name']) ?>"
                                       value="<?= htmlspecialchars($data[$field['dataScope']] ?? '') ?>"
                                        <?= $field['required'] ? 'required' : '' ?>>
                            <?php endif; ?>

                            <?php if ($field['notice']): ?>
                                <small class="field-notice"><?= htmlspecialchars($field['notice']) ?></small>
                            <?php endif; ?>
                        </div>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        <?php endforeach; ?>
    </form>
</div>

<!-- Image Picker Modal -->
<div id="image-picker-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üñºÔ∏è Select Image</h2>
            <button id="btn-close-image-picker" class="btn-close" title="Close">√ó</button>
        </div>
        <div class="modal-body">
            <iframe id="image-picker-frame" src=""></iframe>
        </div>
    </div>
</div>

<!-- Form rendered within admin layout (head/body/html tags provided by layout system) -->
<!-- JavaScript handlers in: /Theme/view/adminhtml/web/js/admin.js -->
<!-- Image Picker - Only loaded on pages with image picker widget -->
<script src="/static/adminhtml/Cms/js/image-picker-base.js"></script>
<script src="/static/adminhtml/Cms/js/image-picker.js"></script>
