#!/usr/bin/env php
<?php

/**
 * Console Application Entry Point
 */

declare(strict_types=1);

use Symfony\Component\Console\Application;
use Infinri\Core\Console\CommandLoader;
use Infinri\Core\Model\Module\ModuleManager;
use Infinri\Core\Model\Setup\SchemaSetup;
use Infinri\Core\Console\Command\SetupInstallCommand;
use Infinri\Core\Console\Command\SetupUpgradeCommand;
use Infinri\Core\Console\Command\SchemaMigrateCommand;

/**
 * Infinri Console Application
 *
 * CLI tool for managing the Infinri framework
 *
 * Usage:
 *   php bin/console [command] [options]
 *   ./bin/console [command] [options]
 *
 * Examples:
 *   bin/console list
 *   bin/console cache:clear
 *   bin/console module:list
 */

// Bootstrap the application
require __DIR__ . '/../app/bootstrap.php';

// Initialize application
$frontController = initApplication();

// Get ObjectManager
$objectManager = getObjectManager();

// Create console application
$application = new Application('Infinri Framework', '1.0.0');

// Get dependencies for setup commands
/** @var ModuleManager $moduleManager */
$moduleManager = $objectManager->get(ModuleManager::class);
/** @var SchemaSetup $schemaSetup */
$schemaSetup = $objectManager->get(SchemaSetup::class);
/** @var \PDO $connection */
$connection = $objectManager->get(\PDO::class);

// Load commands from command loader
$commandLoader = new CommandLoader();
$commands = $commandLoader->loadCommands();

// Add setup commands with proper dependencies
$commands[] = new SetupInstallCommand($moduleManager, $schemaSetup, $connection);
$commands[] = new SetupUpgradeCommand($moduleManager, $schemaSetup);
$commands[] = new SchemaMigrateCommand($moduleManager, $schemaSetup, $connection);

// Register all commands
$application->addCommands($commands);

// Run the application
$application->run();
