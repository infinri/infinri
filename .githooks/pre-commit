#!/bin/bash

# Infinri Framework - Pre-commit Hook
# This script runs code quality checks before each commit

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if vendor directory exists
if [ ! -d "vendor" ]; then
    echo -e "${RED}‚ùå Vendor directory not found. Run 'composer install' first.${NC}"
    exit 1
fi

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úÖ No PHP files to check.${NC}"
    exit 0
fi

echo -e "${YELLOW}üìÅ Checking staged PHP files:${NC}"
echo "$STAGED_FILES"
echo ""

# Create temp directory for checks
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Copy staged files to temp directory
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        TEMP_FILE="$TEMP_DIR/$FILE"
        mkdir -p "$(dirname "$TEMP_FILE")"
        cp "$FILE" "$TEMP_FILE"
    fi
done

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# 1. PHP Syntax Check
echo -e "${YELLOW}üîç Checking PHP syntax...${NC}"
SYNTAX_ERRORS=0
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        php -l "$FILE" >/dev/null 2>&1 || {
            echo -e "${RED}‚ùå Syntax error in $FILE${NC}"
            SYNTAX_ERRORS=1
        }
    fi
done

if [ $SYNTAX_ERRORS -eq 1 ]; then
    echo -e "${RED}‚ùå PHP syntax errors found. Please fix them before committing.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ PHP syntax check passed${NC}"

# 2. PHPStan Analysis (if available)
if command_exists vendor/bin/phpstan; then
    echo -e "${YELLOW}üîç Running PHPStan analysis...${NC}"
    
    # Create temporary phpstan config for staged files only
    TEMP_PHPSTAN_CONFIG="$TEMP_DIR/phpstan.neon"
    cat > "$TEMP_PHPSTAN_CONFIG" << EOF
parameters:
    level: 8
    paths:
$(for FILE in $STAGED_FILES; do echo "        - $FILE"; done)
    bootstrapFiles:
        - app/bootstrap.php
    ignoreErrors:
        - '#Parameter \#\d+ \$\w+ of method .* expects .*, mixed given#'
        - '#Access to an undefined property SimpleXMLElement::\$\w+#'
    tmpDir: var/cache/phpstan
EOF
    
    if ! vendor/bin/phpstan analyse -c "$TEMP_PHPSTAN_CONFIG" --no-progress --quiet; then
        echo -e "${RED}‚ùå PHPStan analysis failed. Please fix the issues before committing.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ PHPStan analysis passed${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è PHPStan not found, skipping static analysis${NC}"
fi

# 3. Code Style Check (PHP CS Fixer)
if command_exists vendor/bin/php-cs-fixer; then
    echo -e "${YELLOW}üé® Checking code style...${NC}"
    
    # Check each staged file
    STYLE_ERRORS=0
    for FILE in $STAGED_FILES; do
        if [ -f "$FILE" ]; then
            if ! vendor/bin/php-cs-fixer fix "$FILE" --dry-run --quiet --config=.php-cs-fixer.php; then
                echo -e "${RED}‚ùå Code style issues in $FILE${NC}"
                STYLE_ERRORS=1
            fi
        fi
    done
    
    if [ $STYLE_ERRORS -eq 1 ]; then
        echo -e "${RED}‚ùå Code style issues found.${NC}"
        echo -e "${YELLOW}üí° Run 'make fix' to automatically fix style issues.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Code style check passed${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è PHP CS Fixer not found, skipping code style check${NC}"
fi

# 4. PHPCS Check (if available and no PHP CS Fixer)
if command_exists vendor/bin/phpcs && ! command_exists vendor/bin/php-cs-fixer; then
    echo -e "${YELLOW}üìè Running PHPCS...${NC}"
    
    if ! vendor/bin/phpcs --standard=phpcs.xml $STAGED_FILES; then
        echo -e "${RED}‚ùå PHPCS found coding standard violations.${NC}"
        echo -e "${YELLOW}üí° Run 'make cs-fix' to automatically fix some issues.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ PHPCS check passed${NC}"
fi

# 5. Check for debugging statements
echo -e "${YELLOW}üêõ Checking for debugging statements...${NC}"
DEBUG_FOUND=0
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        # Check for common debugging statements
        if grep -n -E "(var_dump|print_r|error_log|dump|dd\()" "$FILE" >/dev/null; then
            echo -e "${RED}‚ùå Debugging statement found in $FILE:${NC}"
            grep -n -E "(var_dump|print_r|error_log|dump|dd\()" "$FILE" || true
            DEBUG_FOUND=1
        fi
    fi
done

if [ $DEBUG_FOUND -eq 1 ]; then
    echo -e "${RED}‚ùå Debugging statements found. Please remove them before committing.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ No debugging statements found${NC}"

# 6. Check for TODO/FIXME comments in new code
echo -e "${YELLOW}üìù Checking for TODO/FIXME comments...${NC}"
TODO_FOUND=0
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        # Only check added lines (not existing ones)
        if git diff --cached "$FILE" | grep -E "^\+" | grep -E "(TODO|FIXME|XXX)" >/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è TODO/FIXME comment found in $FILE${NC}"
            TODO_FOUND=1
        fi
    fi
done

if [ $TODO_FOUND -eq 1 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è TODO/FIXME comments found in new code. Consider addressing them.${NC}"
    # Don't exit, just warn
fi

echo ""
echo -e "${GREEN}üéâ All pre-commit checks passed!${NC}"
echo -e "${GREEN}‚úÖ Ready to commit${NC}"

exit 0
